/*! ng-scratch-off - v0.1.0 - 2013-07-27
* http://shoppinpal.github.io/ng-scratch-off
* Copyright (c) 2013 Jeff French
* This is a port of code by Wes Pickett. Original code here: http://wespickett.com/blog#feb0212 
* Licensed MIT */
angular.module("shoppinpal.scratch-off",[]).provider("scratchOffConfig",function(){var a,b="You win!",c="#000000",d="16px Arial",e="#01fefa",f=!1,g="#7d7c83",h=!1,i="Scratch Me!",j="#80fe01",k="16px Arial";this.$get=function(){return{waitForEvent:a,hiddenText:b,hiddenTextColor:c,hiddenTextFont:d,hiddenBackgroundColor:e,hiddenBackgroundImage:f,scratchOffColor:g,scratchOffImage:h,scratchOffText:i,scratchOffTextColor:j,scratchOffTextFont:k}}}).directive("scratchOff",["scratchOffConfig",function(a){var b='<div id="scratchOffContainer{{ $id }}"><canvas id="hiddenCanvas{{ $id }}" width="{{ canvasWidth }}" height="{{ canvasHeight }}"></canvas><canvas id="scratchOffCanvas{{ $id }}" width="{{ canvasWidth }}" height="{{ canvasHeight }}"></canvas></div>';return{restrict:"EAC",replace:!0,template:b,scope:{hiddenText:"@",hiddenTextColor:"@",hiddenTextFont:"@",hiddenBackgroundColor:"@",hiddenBackgroundImage:"@",scratchOffColor:"@",scratchOffImage:"@",scratchOffText:"@",scratchOffTextColor:"@",scratchOffTextFont:"@",canvasWidth:"@width",canvasHeight:"@height"},link:function(b){function c(){var a=document.getElementById("scratchOffCanvas"+b.$id),c=document.getElementById("hiddenCanvas"+b.$id);f=a.getContext("2d"),g=c.getContext("2d"),h=a.width,i=a.height;var k=!!("ontouchstart"in window),l=k?"touchstart":"mousedown",m=k?"touchmove":"mousemove",n=k?"touchend":"mouseup";j=angular.element(a),j.css({position:"absolute",top:g.canvas.offsetTop+"px",left:g.canvas.offsetLeft+"px",opacity:"1",transition:"opacity .25s ease-out","-moz-transition":"opacity .25s ease-out","-webkit-transition":"opacity .25s ease-out"}),j.bind(l,function(a){v=!0;var b=k?a.touches[0].pageX:a.pageX,c=k?a.touches[0].pageY:a.pageY,d=b-this.offsetLeft,f=c-this.offsetTop;e(d,f,!0)}),j.bind(m,function(a){var b=k?a.touches[0].pageX:a.pageX,c=k?a.touches[0].pageY:a.pageY,d=b-this.offsetLeft,f=c-this.offsetTop;v&&e(d,f,!1)}),j.bind(n,function(){v=!1}),d()}function d(){if(r){var a=document.getElementById(r);f.drawImage(a,0,0)}else f.fillStyle=q,f.fillRect(0,0,h,i);if(f.fillStyle=t,f.font=u,f.textAlign="center",f.textBaseline="middle",f.fillText(s,h/2,i/2,.8*h),p){var b=document.getElementById(p);g.drawImage(b,0,0)}else g.fillStyle=o,g.fillRect(0,0,h,i);g.fillStyle=m,g.font=n,g.textAlign="center",g.textBaseline="middle",g.fillText(l,h/2,i/2,.8*h)}function e(a,b){var c,d,e,g,k,l=f.createImageData(1,1);for(a-=25,b-=25,w++,c=scY=50,k=c/2,f.save(),l.data[3]=0,sy=0;scY>sy;sy++)for(sx=0;c>sx;sx++)d=sx-k,e=sy-k,g=Math.sqrt(d*d+e*e),15>g&&100*Math.random()<65&&f.putImageData(l,a+sx,b+sy),10>g&&100*Math.random()<75&&f.putImageData(l,a+sx,b+sy),5>g&&100*Math.random()<100&&f.putImageData(l,a+sx,b+sy);if(f.restore(),w>100){for(var m=f.getImageData(0,0,h,i),n=0,o=3;4*h*i>o;o+=4)0===m.data[o]&&n++;n>.4*h*i&&j.css({opacity:"0"}),w=0}}var f,g,h,i,j,k=a,l=b.hiddenText||k.hiddenText,m=b.hiddenTextColor||k.hiddenTextColor,n=b.hiddenTextFont||k.hiddenTextFont,o=b.hiddenBackgroundColor||k.hiddenBackgroundColor,p=b.hiddenBackgroundImage||k.hiddenBackgroundImage,q=b.scratchOffColor||k.scratchOffColor,r=b.scratchOffImage||k.scratchOffImage,s=b.scratchOffText||k.scratchOffText,t=b.scratchOffTextColor||k.scratchOffTextColor,u=b.scratchOffTextFont||k.scratchOffTextFont,v=!1,w=0;k.waitForEvent?b.$parent.$on(k.waitForEvent,function(){c()}):angular.element(document).ready(function(){c()})}}}]);